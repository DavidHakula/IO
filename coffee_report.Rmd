---
title: "Competition in the Dutch coffee market"
author: "David Hakula, Christopher Hayes, Filip Mellgren"
date: '2019-04-02'
output:
  word_document: default
  pdf_document: default
  html_document:
    code_folding: hide
    df_print: kable
    highlight: zenburn
    theme: readable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warnings = FALSE)
```

```{r, message=FALSE}
library(rio)
library(tidyverse)
library(AER)
library(ggthemes)
library(stargazer)
library(reshape2)
library(xtable)
```
```{r}
df <- import("dutch_coffee.dta")
```
```{r}

df %>% head() %>% as_tibble()
```

```{r}
# Create time variable
df <- df %>% mutate(time = year + month/12)


# rename variables
df <- df %>% rename(Quantity = qu, 
                    Coffee = cprice, 
                    Tea = tprice,
                    Wage = wprice, 
                    Bean = bprice,
                    Income = incom)
```

## Summary statistics

We begin by showing som esumamry statistics,

### Summary Table
```{r}
#summary(df$Coffee)
xtable(sapply(select(df,Quantity, Coffee, Tea, Wage, Bean), summary)%>% t())
```
```{r}

tmp <- lm(Coffee ~ Bean, data = df)
df$`Coffee adj` <- tmp$residuals
cormatdf <- df %>% select(Coffee, `Coffee adj`, Quantity, Bean, Tea, Wage, Income)
cormat <- round(cor(cormatdf),2)

melted_cormat <- melt(cormat)

melted_cormat %>% ggplot(aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile() + theme_economist() + scale_colour_economist() +
  labs(title = "Correlation matrix", y = " ", x = " ") +
  scale_fill_gradient2(low = "#336666", high = "#664033", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Pearson\nCorrelation")
```


### Per capita consumption of roasted coffe and price of roasted coffee

```{r}
# Coffee and tea and quantity indexed
df <- df %>% mutate("coffee price" = Coffee/Coffee[1]*100,
              "tea price" = Tea/Tea[1]*100,
              "pc coffee cons." = Quantity/Quantity[1]*100,
              "price coffee beans" = Bean/Bean[1]*100) 

df %>% gather(`coffee price`, `tea price`, `pc coffee cons.`, key = "index", value = "price") %>% 
  ggplot(aes(x = time, y = price, color = index )) +
  geom_line() +
  theme_economist() + scale_colour_economist() +
  labs(y = "Indexed price and consumption", x = "Year", title = "Volatility in consumption...", subtitle = "...Is seemingly, unrelated to the relative price of coffee and tea")
```
```{r}
# Calculate correlations
cor(df$Coffee, df$Tea)
cor(df$Coffee, df$Quantity)
cor(df$Tea, df$Quantity)
```
```{r}
df %>% rename(`Roasted coffee` = Coffee, `Coffee bean` = Bean) %>% gather(`Roasted coffee`, `Coffee bean`, key = "Series", 
              value = "price") %>% 
  ggplot(aes(x = time, y = price, color = Series )) +
  geom_line() +
  theme_economist() + scale_colour_economist() +
  labs(y = "Guilders per kg", x = "Year", 
       title = "Bean price spike hits roasted prices hard")
```

### c and d
```{r}
df <- df %>% mutate("roasted coffee" = Coffee/Coffee[1]*100,
              tea = Tea/Tea[1]*100,
              wages = Wage/Wage[1]*100) 

df %>% gather(`roasted coffee`, tea, wages, key = "Index", value = "price") %>% 
  ggplot(aes(x = time, y = price, color = Index)) +
  geom_line() +
  theme_economist() + scale_colour_economist() + 
  labs(y = "Indexed prices", x = "Year", 
       title = "Caffeine shock...",
       subtitle = "...but wages and tea prices left unaffected")
```


## Regressions and demand estimation

We begin by inflation adjust the variables.
```{r}
df <- df %>% mutate(Coffee = Coffee / oprice,
              Wage = Wage / oprice,
              Tea = Tea / oprice)

no_controls <- lm(log(Quantity) ~ log(Coffee), data = df)
quarter_controls <- lm(log(Quantity) ~ log(Coffee) + q1 + q2 + q3, data = df)
```
First, we run a regression without any controls
$log(Q) = \beta_0 + \beta_1 log(P) + \varepsilon$

Second
$log(Q) = \beta_0 + \beta_1 log(P) + \beta_2´Q+ \varepsilon$

Where $Q$ are quarterly dummies.

Third,
$log(Q) = \beta_0 + \beta_1 log(P) + \beta_2´Q+ \beta_3* T + \varepsilon$

where $T$ denotes tea.

Finally, we run the regression 
$log(Q) = \beta_0 + \beta_1 log(P) + \beta_2´Q+ \beta_3* log(T) + log(income) +  \varepsilon$


Note to ourselves: following probably unecesary

$Q = e^{\beta_0 + \beta_1 log(P) + \varepsilon}$

$\beta_1 = \frac{dQ}{dP}\frac{P}{Q}$

```{r}
tea_control <- lm(log(Quantity) ~log(Coffee) + q1 + q2 + q3 + log(Tea), data = df)
income_control <- lm(log(Quantity) ~log(Coffee) + q1 + q2 + q3 + log(Tea) +
                       log(Income), data = df)

# seasonal controls summary

```

## Supply and demand shifters
Start from the data that we have.

Valid instrument, corr(zx) > 0, E(z epsilon) = 0.
How to find instruments? 

Supply shift: wages, prices of beans

Demand shift: 


## One major concern



```{r}
IV_spec <- ivreg(log(Quantity) ~ log(Coffee) + q1 + q2 + q3 + log(Tea) +
                       log(Income) | q1 + q2 + q3 + log(Tea) +
                       log(Income) + log(Bean) + log(Wage), data = df)
stargazer(no_controls, quarter_controls, tea_control, 
          income_control, IV_spec,  
          column.sep.width = "2pt", 
          font.size = "normalsize", 
          omit.stat = c("f", "ser", "adj.rsq"), 
          no.space = TRUE, header = FALSE)

summary(IV_spec, diagnostics = TRUE)
```

## Degree of competition in the Dutch coffee market
Emphasize the log log specification and constant elasticty of demand

```{r}
c0 = 4
h = 1.19
df <- df %>% mutate(c = c0 + h*Bean) # we know the cost already
```

### Adjusted and unadjusted Lerner indices

We calculate:
$L = \frac{P-c}{P}$
```{r}
df <- df %>% mutate(L = (Coffee - c)/Coffee)
```


$L_\eta = \frac{P-c}{P} \hat{\eta}$

```{r}

eta = IV_spec[[1]][2] # The price elastsicity of demand from the IV
df <- df %>% mutate(L_adj = -eta * L) #invert the sign
```



```{r}
# Summary statistics for both and seasonal variation (plot)
df %>% gather(L, L_adj, key = Type, value = Lerner_index) %>%
  ggplot(aes(x = time, y = Lerner_index, color = Type)) +
  geom_line() +
  theme_economist() + scale_colour_economist() +
  labs(title = "Markups are decreasing",
       y = "Lerner index", x = "Year")


```


```{r}
quarterly_table <- df %>% group_by(q1, q2, q3, q4) %>% 
  summarize("mean unadjusted" = mean(L),
            "mean adjusted" = mean(L_adj),
            "std unadjusted" = sqrt(var(L)),
            "std adjusted" = sqrt(var(L_adj))) %>%
  mutate(quarter = case_when(
    q1 == 1 ~ "Q1",
    q2 == 1 ~ "Q2",
    q3 == 1 ~ "Q3",
    q4 == 1 ~ "Q4")) %>%
  as_tibble()

quarterly_table <- quarterly_table %>% select(-q1, -q2, -q3, -q4) %>%
  select(quarter, everything()) %>%
  arrange(quarter)
library(xtable)
xtable(quarterly_table, digits = 3)
```

## Conduct parameter
Estimate for the entire period
$P = \frac{\eta c}{\eta - \lambda}$

$P = b*c$, estimate $\hat{b}$ from a regression and solve for lambda:

$\hat{b} = \frac{\eta}{\eta - \hat{\lambda}}$

We estimate the following regression: $P_{coffee} = b* cost + \beta' Q$
where $Q$ is a vector of four quarterly dummies (including all four because we don't include any intercept).
```{r}
no_dummies <- lm(Coffee ~ c + 0, data = df) # plus 0 for no intercept
dummies <- lm(Coffee ~ c + 0 + q1 + q2 + q3 + q4 + 
                  log(Tea) + log(Income), data = df) # add controls
# obtain estimate of b
b <- dummies$coefficients[1]
```

We obtain the following estimate for $b$: `r round(b, 2)` which we use to plug into the following formula: 

$\lambda = \frac{\hat{\eta} (\hat{b} - 1)}{\hat{b}}$
```{r}
lambda = -eta * (b-1)/b
```

We estimate $\lambda = $ `r round(lambda,3)`, which means the market is composed of 

$\frac{1}{\lambda} =$ `r round(1/lambda,2)` equally sized firms.



